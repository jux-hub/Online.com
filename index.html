<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>InvestPro | Calculadora de Renda Fixa com IA e Dados Reais</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500;700&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    },
                    colors: {
                        brand: { 500: '#10b981', 600: '#059669', 900: '#064e3b' },
                        accent: { 500: '#3b82f6', 600: '#2563eb' },
                        dark: { 800: '#1e293b', 900: '#0f172a' }
                    }
                }
            }
        }
    </script>

    <style>
        /* Estilos Personalizados e Glassmorphism */
        body {
            background: radial-gradient(circle at top left, #f8fafc, #e2e8f0);
            min-height: 100vh;
        }
        .glass-panel {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
        }
        .input-focus:focus-within {
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.2);
            border-color: #10b981;
        }
        
        /* Sliders Personalizados */
        input[type="range"] {
            -webkit-appearance: none;
            background: transparent;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 20px;
            width: 20px;
            border-radius: 50%;
            background: #10b981;
            cursor: pointer;
            margin-top: -8px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
            transition: transform 0.1s;
        }
        input[type="range"]::-webkit-slider-thumb:hover {
            transform: scale(1.2);
        }
        input[type="range"]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            cursor: pointer;
            background: #e2e8f0;
            border-radius: 2px;
        }

        /* Animações */
        @keyframes pulse-ring {
            0% { transform: scale(0.8); box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7); }
            70% { transform: scale(1); box-shadow: 0 0 0 10px rgba(16, 185, 129, 0); }
            100% { transform: scale(0.8); box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); }
        }
        .live-indicator {
            animation: pulse-ring 2s infinite;
        }

        /* Estilos de Impressão */
        @media print {
            body { background: white; }
            .no-print { display: none !important; }
            .glass-panel { box-shadow: none; border: 1px solid #ccc; }
            canvas { max-height: 300px !important; }
            .print-break { page-break-before: always; }
        }
    </style>
</head>
<body class="text-slate-800 pb-12">

    <header class="sticky top-0 z-40 glass-panel border-b border-slate-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
            <div class="flex flex-col md:flex-row items-center justify-between gap-4">
                <div class="flex items-center gap-3">
                    <div class="bg-gradient-to-br from-brand-500 to-brand-600 text-white p-2.5 rounded-xl shadow-lg">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path></svg>
                    </div>
                    <div>
                        <h1 class="text-xl font-bold text-slate-900 tracking-tight">InvestPro <span class="text-brand-600">Analytics</span></h1>
                        <p class="text-xs text-slate-500 font-medium">Dados do Banco Central em Tempo Real</p>
                    </div>
                </div>

                <div class="flex items-center gap-2 overflow-x-auto w-full md:w-auto pb-2 md:pb-0 hide-scrollbar">
                    <div id="api-status" class="flex items-center gap-1.5 px-3 py-1.5 bg-slate-100 rounded-full border border-slate-200 text-xs font-semibold text-slate-500 whitespace-nowrap">
                        <span class="w-2 h-2 rounded-full bg-slate-400"></span>
                        Conectando...
                    </div>

                    <div class="flex items-center gap-3 px-4 py-1.5 bg-white rounded-full border border-slate-200 shadow-sm whitespace-nowrap">
                        <span class="text-xs font-bold text-slate-500 uppercase">Selic</span>
                        <span id="ticker-selic" class="text-sm font-mono font-bold text-brand-600">--%</span>
                    </div>
                    
                    <div class="flex items-center gap-3 px-4 py-1.5 bg-white rounded-full border border-slate-200 shadow-sm whitespace-nowrap">
                        <span class="text-xs font-bold text-slate-500 uppercase">CDI</span>
                        <span id="ticker-cdi" class="text-sm font-mono font-bold text-accent-600">--%</span>
                    </div>

                    <div class="flex items-center gap-3 px-4 py-1.5 bg-white rounded-full border border-slate-200 shadow-sm whitespace-nowrap" title="Inflação acumulada 12 meses">
                        <span class="text-xs font-bold text-slate-500 uppercase flex items-center gap-1">
                            IPCA (12m)
                            <svg class="w-3 h-3 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 17h8m0 0V9m0 8l-8-8-4 4-6-6"></path></svg>
                        </span>
                        <span id="ticker-ipca" class="text-sm font-mono font-bold text-red-600">--%</span>
                    </div>
                </div>

                <button onclick="window.print()" class="hidden md:flex items-center gap-2 text-sm font-semibold text-slate-600 hover:text-brand-600 transition-colors no-print">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"></path></svg>
                    Relatório
                </button>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        
        <div class="grid lg:grid-cols-12 gap-8">
            
            <div class="lg:col-span-4 space-y-6 no-print">
                <div class="bg-white rounded-2xl shadow-xl p-6 border border-slate-100 relative overflow-hidden">
                    <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-brand-500 to-accent-500"></div>
                    
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-lg font-bold text-slate-800 flex items-center gap-2">
                            <svg class="w-5 h-5 text-brand-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"></path></svg>
                            Parâmetros
                        </h2>
                        <button onclick="fetchData()" class="text-xs bg-slate-100 hover:bg-brand-50 text-slate-600 hover:text-brand-600 px-3 py-1.5 rounded-md transition-colors font-medium flex items-center gap-1">
                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                            Atualizar Taxas
                        </button>
                    </div>

                    <div class="mb-5">
                        <label class="block text-sm font-semibold text-slate-700 mb-2">Valor da Aplicação</label>
                        <div class="relative input-focus rounded-xl transition-all">
                            <span class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 font-bold">R$</span>
                            <input type="text" id="valor" value="10.000,00" 
                                class="w-full pl-12 pr-4 py-3 bg-slate-50 border border-slate-200 rounded-xl font-mono text-lg font-semibold outline-none text-slate-800"
                                oninput="formatCurrency(this); updateCalculations()">
                        </div>
                    </div>

                    <div class="mb-5">
                        <label class="block text-sm font-semibold text-slate-700 mb-2">Aporte Mensal</label>
                        <div class="relative input-focus rounded-xl transition-all">
                            <span class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 font-bold">R$</span>
                            <input type="text" id="aporte" value="0,00" 
                                class="w-full pl-12 pr-4 py-3 bg-slate-50 border border-slate-200 rounded-xl font-mono text-lg font-semibold outline-none text-slate-800"
                                oninput="formatCurrency(this); updateCalculations()">
                        </div>
                    </div>

                    <div class="mb-6">
                        <label class="block text-sm font-semibold text-slate-700 mb-2">Tempo de Investimento</label>
                        <div class="grid grid-cols-2 gap-3">
                            <div class="relative input-focus rounded-xl">
                                <input type="number" id="prazo" value="12" min="1"
                                    class="w-full pl-4 pr-2 py-3 bg-slate-50 border border-slate-200 rounded-xl font-mono text-lg font-semibold outline-none text-center"
                                    onchange="updateCalculations()" oninput="updateCalculations()">
                            </div>
                            <select id="tipo-prazo" onchange="updateCalculations()" 
                                class="bg-slate-50 border border-slate-200 text-slate-700 text-sm rounded-xl focus:ring-brand-500 focus:border-brand-500 block w-full p-2.5 font-semibold outline-none">
                                <option value="meses">Meses</option>
                                <option value="anos">Anos</option>
                            </select>
                        </div>
                        
                        <div class="flex justify-between gap-2 mt-3">
                            <button onclick="setPrazo(6, 'meses')" class="flex-1 py-1 text-xs font-medium bg-slate-100 hover:bg-brand-100 hover:text-brand-700 text-slate-600 rounded-lg transition-colors">6m</button>
                            <button onclick="setPrazo(1, 'anos')" class="flex-1 py-1 text-xs font-medium bg-slate-100 hover:bg-brand-100 hover:text-brand-700 text-slate-600 rounded-lg transition-colors">1a</button>
                            <button onclick="setPrazo(2, 'anos')" class="flex-1 py-1 text-xs font-medium bg-slate-100 hover:bg-brand-100 hover:text-brand-700 text-slate-600 rounded-lg transition-colors">2a</button>
                            <button onclick="setPrazo(5, 'anos')" class="flex-1 py-1 text-xs font-medium bg-slate-100 hover:bg-brand-100 hover:text-brand-700 text-slate-600 rounded-lg transition-colors">5a</button>
                        </div>
                    </div>

                    <div class="h-px bg-slate-100 w-full my-6"></div>

                    <div class="space-y-5">
                        <div>
                            <div class="flex justify-between mb-2">
                                <label class="text-sm font-semibold text-slate-700">CDB / LC (% do CDI)</label>
                                <span class="text-xs font-mono font-bold text-brand-600 bg-brand-50 px-2 py-0.5 rounded" id="label-percentual-cdb">100%</span>
                            </div>
                            <input type="range" id="percentual-cdb" min="80" max="150" value="100" class="w-full" oninput="document.getElementById('label-percentual-cdb').innerText = this.value + '%'; updateCalculations()">
                        </div>

                        <div>
                            <div class="flex justify-between mb-2">
                                <label class="text-sm font-semibold text-slate-700">LCI / LCA (% do CDI)</label>
                                <span class="text-xs font-mono font-bold text-accent-600 bg-accent-50 px-2 py-0.5 rounded" id="label-percentual-lci">90%</span>
                            </div>
                            <input type="range" id="percentual-lci" min="70" max="120" value="90" class="w-full" oninput="document.getElementById('label-percentual-lci').innerText = this.value + '%'; updateCalculations()">
                        </div>
                    </div>

                    <div class="mt-6 bg-slate-50 border border-slate-200 rounded-xl p-3 flex items-center justify-between">
                        <div class="flex flex-col">
                            <span class="text-sm font-bold text-slate-700">Descontar Inflação</span>
                            <span class="text-[10px] text-slate-500">Ver Ganho Real (Poder de Compra)</span>
                        </div>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="check-inflacao" class="sr-only peer" onchange="updateCalculations()">
                            <div class="w-11 h-6 bg-slate-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-brand-500"></div>
                        </label>
                    </div>

                </div>
                
                <div class="bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl p-5 text-white shadow-lg">
                    <h3 class="font-bold text-sm mb-2 flex items-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        Você sabia?
                    </h3>
                    <p class="text-xs opacity-90 leading-relaxed">
                        O CDI (Certificado de Depósito Interbancário) costuma render aproximadamente 0,10 ponto percentual abaixo da Selic Meta. Atualmente, com a Selic em <span id="text-selic-info" class="font-bold">--%</span>, o CDI estimado é de <span id="text-cdi-info" class="font-bold">--%</span>.
                    </p>
                </div>
            </div>

            <div class="lg:col-span-8 space-y-6">
                
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <div class="bg-white p-6 rounded-2xl shadow-lg border-l-4 border-brand-500 relative overflow-hidden group hover:-translate-y-1 transition-transform duration-300">
                        <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity">
                            <svg class="w-16 h-16 text-brand-500" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1.41 16.09V9h-2.67v9.09c0 .58-.53 1.05-1.16 1.05H6.96c-.63 0-1.16-.47-1.16-1.05V9h-2.3c-.62 0-1.11-.64-.84-1.22l6.23-13.6c.32-.7 1.35-.7 1.67 0l6.23 13.6c.27.58-.22 1.22-.84 1.22h-2.3v9.09c0 .58-.53 1.05-1.16 1.05h-2.63c-.63 0-1.16-.47-1.16-1.05z"/></svg>
                        </div>
                        <p class="text-sm font-bold text-slate-500 uppercase tracking-wide">Melhor Rendimento</p>
                        <h3 class="text-2xl font-bold text-slate-800 mt-1" id="best-option-name">Calculando...</h3>
                        <div class="mt-4">
                            <span class="text-xs text-slate-400">Total Líquido Estimado</span>
                            <p class="text-3xl font-mono font-bold text-brand-600" id="best-option-value">R$ 0,00</p>
                        </div>
                        <div class="mt-2 inline-flex items-center gap-1 bg-green-50 text-green-700 px-2 py-1 rounded text-xs font-bold" id="best-option-gain">
                            +R$ 0,00 de lucro
                        </div>
                    </div>

                    <div class="bg-white p-6 rounded-2xl shadow-lg border border-slate-100 hover:-translate-y-1 transition-transform duration-300">
                        <p class="text-sm font-bold text-slate-500 uppercase tracking-wide">Total Investido</p>
                        <p class="text-2xl font-mono font-bold text-slate-800 mt-2" id="total-invested">R$ 0,00</p>
                        <div class="h-px bg-slate-100 my-3"></div>
                        <div class="flex justify-between items-center text-sm">
                            <span class="text-slate-500">Inicial:</span>
                            <span class="font-mono font-medium text-slate-700" id="detail-initial">R$ 0,00</span>
                        </div>
                        <div class="flex justify-between items-center text-sm mt-1">
                            <span class="text-slate-500">Aportes:</span>
                            <span class="font-mono font-medium text-slate-700" id="detail-contributions">R$ 0,00</span>
                        </div>
                    </div>

                    <div class="bg-slate-50 p-6 rounded-2xl shadow-inner border border-slate-200 opacity-80 hover:opacity-100 transition-opacity">
                        <p class="text-sm font-bold text-slate-500 uppercase tracking-wide flex items-center gap-2">
                            Poupança
                            <span class="bg-orange-100 text-orange-600 text-[10px] px-1.5 py-0.5 rounded">Referência</span>
                        </p>
                        <p class="text-xl font-mono font-bold text-slate-600 mt-2" id="poupanca-value">R$ 0,00</p>
                        <p class="text-xs text-red-500 mt-1 font-medium" id="poupanca-diff">Perde R$ 0,00</p>
                        <p class="text-[10px] text-slate-400 mt-3 leading-tight">
                            A poupança rende apenas 70% da Selic + TR (quando Selic > 8.5%). Quase sempre perde para a inflação.
                        </p>
                    </div>
                </div>

                <div class="bg-white rounded-2xl shadow-xl p-6 border border-slate-100">
                    <h3 class="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2">
                        <svg class="w-5 h-5 text-accent-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z"></path></svg>
                        Evolução Patrimonial
                    </h3>
                    <div class="relative h-72 w-full">
                        <canvas id="chartEvolution"></canvas>
                    </div>
                </div>

                <div class="bg-white rounded-2xl shadow-xl overflow-hidden border border-slate-100">
                    <div class="p-4 bg-slate-50 border-b border-slate-200 flex justify-between items-center">
                        <h3 class="font-bold text-slate-700">Comparativo Detalhado</h3>
                        <span class="text-xs text-slate-400 font-mono">Valores Líquidos (Já descontado IR)</span>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left">
                            <thead class="text-xs text-slate-500 uppercase bg-slate-50 border-b border-slate-100">
                                <tr>
                                    <th class="px-6 py-3">Investimento</th>
                                    <th class="px-6 py-3 text-right">Bruto</th>
                                    <th class="px-6 py-3 text-right">IR Estimado</th>
                                    <th class="px-6 py-3 text-right">Líquido Final</th>
                                    <th class="px-6 py-3 text-right">Rentabilidade</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-slate-100" id="comparison-table">
                                </tbody>
                        </table>
                    </div>
                </div>

            </div>
        </div>
    </main>

    <footer class="text-center py-8 text-slate-400 text-sm no-print">
        <p>Desenvolvido com IA • Dados fornecidos pelo Banco Central do Brasil.</p>
        <p class="mt-1 text-xs">Simulação educativa. Não configura recomendação de investimento.</p>
    </footer>

    <script>
        // ================= ESTADO DA APLICAÇÃO =================
        let state = {
            selic: 15.00, // Fallback inicial
            cdi: 14.90,
            ipca: 4.50,
            lastUpdate: null,
            apiConnected: false
        };

        let chartInstance = null;

        // ================= FORMATADORES =================
        const moneyFormatter = new Intl.NumberFormat('pt-BR', {
            style: 'currency',
            currency: 'BRL'
        });

        const percentFormatter = new Intl.NumberFormat('pt-BR', {
            style: 'percent',
            minimumFractionDigits: 2
        });

        function formatCurrency(input) {
            let value = input.value.replace(/\D/g, '');
            value = (value / 100).toFixed(2) + '';
            value = value.replace(".", ",");
            value = value.replace(/(\d)(?=(\d{3})+(?!\d))/g, "$1.");
            input.value = value;
        }

        function parseMoney(value) {
            return parseFloat(value.replace(/\./g, '').replace(',', '.')) || 0;
        }

        // ================= CONEXÃO COM API (BANCO CENTRAL) =================
        async function fetchData() {
            const statusEl = document.getElementById('api-status');
            const selicEl = document.getElementById('ticker-selic');
            const cdiEl = document.getElementById('ticker-cdi');
            const ipcaEl = document.getElementById('ticker-ipca');
            const infoSelic = document.getElementById('text-selic-info');
            const infoCdi = document.getElementById('text-cdi-info');

            statusEl.innerHTML = '<svg class="animate-spin w-3 h-3 mr-1" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Buscando dados...';
            
            try {
                // Busca Selic Meta (Código 432)
                const resSelic = await fetch('https://api.bcb.gov.br/dados/serie/bcdata.sgs.432/dados/ultimos/1?formato=json');
                const dataSelic = await resSelic.json();

                // Busca IPCA acumulado 12 meses (Código 13522)
                const resIpca = await fetch('https://api.bcb.gov.br/dados/serie/bcdata.sgs.13522/dados/ultimos/1?formato=json');
                const dataIpca = await resIpca.json();

                if (dataSelic.length > 0 && dataIpca.length > 0) {
                    state.selic = parseFloat(dataSelic[0].valor);
                    state.cdi = state.selic - 0.10; // Convenção de mercado
                    state.ipca = parseFloat(dataIpca[0].valor);
                    state.apiConnected = true;
                    state.lastUpdate = new Date();

                    // Atualiza UI
                    selicEl.textContent = state.selic.toFixed(2) + '%';
                    cdiEl.textContent = state.cdi.toFixed(2) + '%';
                    ipcaEl.textContent = state.ipca.toFixed(2) + '%';
                    
                    infoSelic.textContent = state.selic.toFixed(2) + '%';
                    infoCdi.textContent = state.cdi.toFixed(2) + '%';

                    statusEl.className = "flex items-center gap-1.5 px-3 py-1.5 bg-green-50 rounded-full border border-green-200 text-xs font-semibold text-green-700 whitespace-nowrap transition-all";
                    statusEl.innerHTML = '<span class="w-2 h-2 rounded-full bg-green-500 live-indicator"></span> Online';
                }
            } catch (error) {
                console.error("Erro ao buscar dados do BCB:", error);
                statusEl.className = "flex items-center gap-1.5 px-3 py-1.5 bg-amber-50 rounded-full border border-amber-200 text-xs font-semibold text-amber-700 whitespace-nowrap";
                statusEl.innerHTML = '<span class="w-2 h-2 rounded-full bg-amber-500"></span> Modo Offline (Dados Estimados)';
                // Mantém valores padrão
            }
            
            updateCalculations();
        }

        // ================= LÓGICA DE CÁLCULO =================
        function getIRTax(days) {
            if (days <= 180) return 22.5;
            if (days <= 360) return 20.0;
            if (days <= 720) return 17.5;
            return 15.0;
        }

        function setPrazo(valor, tipo) {
            document.getElementById('prazo').value = valor;
            document.getElementById('tipo-prazo').value = tipo;
            updateCalculations();
        }

        function calculateCompoundInterest(principal, contribution, months, annualRate, isTaxExempt) {
            // Conversão de taxa anual para mensal
            const monthlyRate = Math.pow(1 + (annualRate / 100), 1 / 12) - 1;
            
            let total = principal;
            let totalInvested = principal;
            let evolution = [principal];

            for (let i = 0; i < months; i++) {
                total = total * (1 + monthlyRate) + contribution;
                totalInvested += contribution;
                evolution.push(total);
            }

            const grossTotal = total;
            const profit = grossTotal - totalInvested;
            
            // Cálculo IR
            const days = months * 30;
            const irRate = isTaxExempt ? 0 : getIRTax(days);
            const irValue = profit * (irRate / 100);
            const netTotal = grossTotal - irValue;

            return {
                grossTotal,
                netTotal,
                profit,
                irValue,
                irRate,
                totalInvested,
                evolution
            };
        }

        function updateCalculations() {
            // Entradas
            const initialValue = parseMoney(document.getElementById('valor').value);
            const monthlyContribution = parseMoney(document.getElementById('aporte').value);
            const timeValue = parseInt(document.getElementById('prazo').value);
            const timeType = document.getElementById('tipo-prazo').value;
            const percentCDB = parseInt(document.getElementById('percentual-cdb').value);
            const percentLCI = parseInt(document.getElementById('percentual-lci').value);
            const useRealGain = document.getElementById('check-inflacao').checked;

            const months = timeType === 'anos' ? timeValue * 12 : timeValue;
            
            // Taxas Efetivas
            const cdbRate = state.cdi * (percentCDB / 100);
            const lciRate = state.cdi * (percentLCI / 100);
            // Poupança (Regra simplificada: 0.5% a.m + TR, aprox 6.17% a.a. + TR, mas usaremos 70% Selic se > 8.5)
            const poupancaRate = state.selic > 8.5 ? (state.selic * 0.7) : state.selic; 
            const tesouroRate = state.selic;

            // Se descontar inflação, ajustamos as taxas nominais para taxas reais aproximadas
            // Fórmula Fisher: (1 + i_nominal) = (1 + i_real) * (1 + inflacao)
            // i_real = (1 + i_nominal) / (1 + inflacao) - 1
            const adjustForInflation = (nominalRate) => {
                if (!useRealGain) return nominalRate;
                const r = (1 + nominalRate/100) / (1 + state.ipca/100) - 1;
                return r * 100;
            };

            // Cálculos
            // Nota: Para "Ganho Real", aplicamos a deflação no valor final ou ajustamos a taxa. 
            // Ajustar a taxa é mais simples para projeção linear no gráfico.
            
            const results = [
                {
                    name: "CDB / LC (" + percentCDB + "% CDI)",
                    type: "cdb",
                    data: calculateCompoundInterest(initialValue, monthlyContribution, months, adjustForInflation(cdbRate), false),
                    color: "#10b981", // brand-500
                    borderColor: "#059669"
                },
                {
                    name: "LCI / LCA (" + percentLCI + "% CDI)",
                    type: "lci",
                    data: calculateCompoundInterest(initialValue, monthlyContribution, months, adjustForInflation(lciRate), true),
                    color: "#3b82f6", // accent-500
                    borderColor: "#2563eb"
                },
                {
                    name: "Tesouro Selic",
                    type: "tesouro",
                    data: calculateCompoundInterest(initialValue, monthlyContribution, months, adjustForInflation(tesouroRate), false),
                    color: "#8b5cf6", // purple-500
                    borderColor: "#7c3aed"
                },
                {
                    name: "Poupança",
                    type: "poupanca",
                    data: calculateCompoundInterest(initialValue, monthlyContribution, months, adjustForInflation(poupancaRate), true),
                    color: "#f59e0b", // amber-500
                    borderColor: "#d97706"
                }
            ];

            // Ordenar por melhor resultado líquido
            results.sort((a, b) => b.data.netTotal - a.data.netTotal);
            const best = results[0];
            const poupanca = results.find(r => r.type === 'poupanca');

            // Atualizar UI Principal
            document.getElementById('total-invested').textContent = moneyFormatter.format(best.data.totalInvested);
            document.getElementById('detail-initial').textContent = moneyFormatter.format(initialValue);
            document.getElementById('detail-contributions').textContent = moneyFormatter.format(best.data.totalInvested - initialValue);

            document.getElementById('best-option-name').textContent = best.name;
            document.getElementById('best-option-value').textContent = moneyFormatter.format(best.data.netTotal);
            document.getElementById('best-option-gain').textContent = `+${moneyFormatter.format(best.data.netTotal - best.data.totalInvested)} de lucro ${useRealGain ? 'real' : 'líquido'}`;

            // Comparativo Poupança
            document.getElementById('poupanca-value').textContent = moneyFormatter.format(poupanca.data.netTotal);
            const diffPoupanca = best.data.netTotal - poupanca.data.netTotal;
            document.getElementById('poupanca-diff').textContent = `Deixa de ganhar ${moneyFormatter.format(diffPoupanca)}`;

            // Tabela Comparativa
            const tableBody = document.getElementById('comparison-table');
            tableBody.innerHTML = '';
            
            results.forEach(res => {
                const isBest = res.type === best.type;
                const row = `
                    <tr class="bg-white hover:bg-slate-50 transition-colors ${isBest ? 'bg-green-50/50' : ''}">
                        <td class="px-6 py-4 font-medium text-slate-900 flex items-center gap-2">
                            <span class="w-3 h-3 rounded-full" style="background-color: ${res.color}"></span>
                            ${res.name}
                            ${isBest ? '<span class="text-[10px] bg-green-100 text-green-700 px-1.5 py-0.5 rounded font-bold uppercase ml-2">Melhor</span>' : ''}
                        </td>
                        <td class="px-6 py-4 text-right text-slate-500 font-mono">${moneyFormatter.format(res.data.grossTotal)}</td>
                        <td class="px-6 py-4 text-right text-red-400 font-mono text-xs">
                            ${res.data.irValue > 0 ? '-' + moneyFormatter.format(res.data.irValue) : 'Isento'}
                            <br><span class="opacity-50">(${res.data.irRate}%)</span>
                        </td>
                        <td class="px-6 py-4 text-right font-bold font-mono ${isBest ? 'text-brand-600' : 'text-slate-700'}">${moneyFormatter.format(res.data.netTotal)}</td>
                        <td class="px-6 py-4 text-right font-mono text-xs font-bold text-slate-500">
                            ${((res.data.netTotal / res.data.totalInvested - 1) * 100).toFixed(2)}%
                        </td>
                    </tr>
                `;
                tableBody.innerHTML += row;
            });

            // Atualizar Gráfico
            updateChart(results, months, useRealGain, initialValue, monthlyContribution);
        }

        // ================= GRÁFICOS (Chart.js) =================
        function updateChart(results, months, isRealGain, initialValue, monthlyContribution) {
            const ctx = document.getElementById('chartEvolution').getContext('2d');
            
            // Labels (Meses)
            const labels = Array.from({length: months + 1}, (_, i) => i === 0 ? 'Início' : i);
            
            // Se NÃO estivermos no modo "Ganho Real", vamos plotar uma linha de inflação para comparação
            let datasets = results.map(res => ({
                label: res.name,
                data: res.data.evolution,
                borderColor: res.color,
                backgroundColor: res.color + '10', // Transparência
                borderWidth: 2,
                pointRadius: 0,
                pointHoverRadius: 6,
                tension: 0.4,
                fill: false
            }));

            // Linha de Inflação (Apenas visual, se não estiver descontando já)
            if (!isRealGain) {
                let inflacaoTotal = initialValue;
                const inflacaoData = [initialValue];
                const inflacaoRateMonthly = Math.pow(1 + (state.ipca / 100), 1 / 12) - 1;
                
                for(let i=0; i<months; i++) {
                    inflacaoTotal = inflacaoTotal * (1 + inflacaoRateMonthly) + monthlyContribution;
                    inflacaoData.push(inflacaoTotal);
                }
                
                datasets.push({
                    label: 'Inflação (Corrosão)',
                    data: inflacaoData,
                    borderColor: '#ef4444',
                    borderWidth: 2,
                    borderDash: [5, 5],
                    pointRadius: 0,
                    tension: 0.4,
                    fill: false
                });
            }

            if (chartInstance) {
                chartInstance.destroy();
            }

            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                            align: 'end',
                            labels: { usePointStyle: true, boxWidth: 8, font: {family: 'Inter', size: 11} }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(255, 255, 255, 0.95)',
                            titleColor: '#1e293b',
                            bodyColor: '#475569',
                            borderColor: '#e2e8f0',
                            borderWidth: 1,
                            padding: 10,
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                        label += new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(context.parsed.y);
                                    }
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: { display: false },
                            ticks: { maxTicksLimit: 12, font: {size: 10} }
                        },
                        y: {
                            border: { display: false },
                            grid: { color: '#f1f5f9' },
                            ticks: {
                                callback: function(value) {
                                    if(value >= 1000000) return 'R$ ' + (value/1000000).toFixed(1) + 'M';
                                    if(value >= 1000) return 'R$ ' + (value/1000).toFixed(0) + 'k';
                                    return value;
                                },
                                font: {family: 'JetBrains Mono', size: 10}
                            }
                        }
                    }
                }
            });
        }

        // ================= INICIALIZAÇÃO =================
        window.addEventListener('DOMContentLoaded', () => {
            fetchData(); // Busca dados reais ao iniciar
        });

    </script>
</body>
</html>
